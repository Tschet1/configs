<html>
    <script>
        function performCommand(event)
{
    if (event.command === "googleThat") {
        var currentURL = event.target.browserWindow.activeTab.url;
        if (currentURL){
            currentURL = currentURL.replace(/\%20/g, "+").replace(/^https*:\/\//,"").replace(/\/$/,"");
            event.target.browserWindow.activeTab.url = `http://www.google.com/search?q=${currentURL}`;
        }
    }
}

function validateCommand(event)
{
    if (event.command === "googleThat") {
        // Disable the button if there is no URL loaded in the tab.
        event.target.disabled = !event.target.browserWindow.activeTab.url;
    }
}

// if event handlers are in the global HTML page,
// register with application:
safari.application.addEventListener("command", performCommand, false);
safari.application.addEventListener("validate", validateCommand, false);
    </script>
</html>
